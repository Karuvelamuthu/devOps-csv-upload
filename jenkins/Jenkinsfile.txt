#!/usr/bin/env groovy

pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'csv-upload'
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_USERNAME = credentials('docker-username')
        DOCKER_PASSWORD = credentials('docker-password')
        KUBE_NAMESPACE = 'default'
        APP_NAME = 'csv-upload'
    }

    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }

    stages {
        stage('Initialization') {
            steps {
                script {
                    echo "================================"
                    echo "Pipeline Started"
                    echo "================================"
                    echo "Project: ${APP_NAME}"
                    echo "Docker Image: ${DOCKER_IMAGE}"
                    echo "Namespace: ${KUBE_NAMESPACE}"
                    echo "================================"
                }
            }
        }

        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }

        stage('Validate') {
            steps {
                script {
                    echo 'Validating project structure...'
                    sh '''
                        echo "Checking required files..."
                        test -f backend/server.js || (echo "Error: backend/server.js not found"; exit 1)
                        test -f backend/package.json || (echo "Error: backend/package.json not found"; exit 1)
                        test -f backend/Dockerfile || (echo "Error: backend/Dockerfile not found"; exit 1)
                        test -f k8s/deployment.yaml || (echo "Error: k8s/deployment.yaml not found"; exit 1)
                        echo "All required files present ✓"
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo 'Building Docker image...'
                    sh '''
                        docker build -t ${DOCKER_IMAGE}:latest \
                          -t ${DOCKER_IMAGE}:${BUILD_NUMBER} \
                          backend/
                        
                        echo "Image built successfully"
                        docker images | grep ${DOCKER_IMAGE}
                    '''
                }
            }
        }

        stage('Push to Registry') {
            steps {
                script {
                    echo 'Pushing image to Docker registry...'
                    sh '''
                        echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
                        
                        docker tag ${DOCKER_IMAGE}:latest ${DOCKER_REGISTRY}/${DOCKER_USERNAME}/${DOCKER_IMAGE}:latest
                        docker tag ${DOCKER_IMAGE}:${BUILD_NUMBER} ${DOCKER_REGISTRY}/${DOCKER_USERNAME}/${DOCKER_IMAGE}:${BUILD_NUMBER}
                        
                        docker push ${DOCKER_REGISTRY}/${DOCKER_USERNAME}/${DOCKER_IMAGE}:latest
                        docker push ${DOCKER_REGISTRY}/${DOCKER_USERNAME}/${DOCKER_IMAGE}:${BUILD_NUMBER}
                        
                        docker logout
                        echo "Images pushed successfully"
                    '''
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo 'Deploying to Kubernetes...'
                    sh '''
                        echo "Applying ServiceAccount..."
                        kubectl apply -f k8s/serviceaccount.yaml
                        
                        echo "Applying Service and ConfigMaps..."
                        kubectl apply -f k8s/service.yaml
                        
                        echo "Applying Deployment..."
                        kubectl apply -f k8s/deployment.yaml
                        
                        echo "Waiting for rollout..."
                        kubectl rollout status deployment/${APP_NAME} -n ${KUBE_NAMESPACE} --timeout=5m
                    '''
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    echo 'Verifying deployment...'
                    sh '''
                        echo "Checking pods..."
                        kubectl get pods -n ${KUBE_NAMESPACE} -l app=${APP_NAME}
                        
                        echo "Checking service..."
                        kubectl get svc ${APP_NAME} -n ${KUBE_NAMESPACE}
                        
                        echo "Checking deployment..."
                        kubectl get deployment ${APP_NAME} -n ${KUBE_NAMESPACE}
                    '''
                }
            }
        }

        stage('Health Check') {
            steps {
                script {
                    echo 'Running health checks...'
                    sh '''
                        echo "Waiting for service to be ready..."
                        sleep 10
                        
                        echo "Testing health endpoint..."
                        POD=$(kubectl get pods -n ${KUBE_NAMESPACE} -l app=${APP_NAME} -o jsonpath='{.items[0].metadata.name}')
                        echo "Testing pod: ${POD}"
                        
                        kubectl exec -n ${KUBE_NAMESPACE} ${POD} -c app -- \
                          curl -s http://localhost:3000/health || echo "Health check initiated"
                    '''
                }
            }
        }

        stage('Post Deployment') {
            steps {
                script {
                    echo 'Post deployment information...'
                    sh '''
                        echo "================================"
                        echo "Deployment Complete"
                        echo "================================"
                        echo "Application: ${APP_NAME}"
                        echo "Namespace: ${KUBE_NAMESPACE}"
                        echo "Docker Image: ${DOCKER_IMAGE}"
                        echo "================================"
                        
                        echo "Get LoadBalancer IP:"
                        echo "kubectl get svc ${APP_NAME} -n ${KUBE_NAMESPACE}"
                        
                        echo ""
                        echo "View logs:"
                        echo "kubectl logs deployment/${APP_NAME} -n ${KUBE_NAMESPACE} -c app"
                        
                        echo ""
                        echo "Port forward:"
                        echo "kubectl port-forward svc/${APP_NAME} 8080:80 -n ${KUBE_NAMESPACE}"
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Cleaning up...'
            sh 'docker logout || true'
            cleanWs()
        }
        success {
            echo '✓ Pipeline succeeded'
        }
        failure {
            echo '✗ Pipeline failed'
            sh '''
                echo "Getting failure details..."
                kubectl get pods -n ${KUBE_NAMESPACE} -l app=${APP_NAME} || true
                kubectl logs deployment/${APP_NAME} -n ${KUBE_NAMESPACE} -c app --tail=50 || true
            '''
        }
    }
}